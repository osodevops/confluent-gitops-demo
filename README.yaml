---
#
# This is the canonical configuration for the `README.md`
# Run `make readme` to rebuild the `README.md`
#

# Name of this project
name: "Confluent GitOps Demo"

# Short description of this project
description: |-
  Fully automated Confluent Platform Demo which deploys Kafka in multiple namespaces and uses the TF Controller with Confluent Terraform Provider to provision Confluent Cloud resources.

# Canonical GitHub repo
github_repo: osodevops/confluent-gitops-demo

# How to use this project
usage: |-
  
  The Toolkit components consist of Source Controller, Kustomize Controller, Helm Controller, Notification Controller and the Image Automation Controllers.
  ```
  ├── flux-system
  │   ├── gotk-components.yaml
  │   ├── gotk-sync.yaml
  │   └── kustomization.yaml
  ├── kustomize
  │   ├── base
  │   │   ├── confluent
  │   │   │   ├── connect
  │   │   │   │   ├── kafka-connect.yaml
  │   │   │   │   └── kustomization.yaml
  │   │   │   ├── control-centre
  │   │   │   │   ├── control-centre.yaml
  │   │   │   │   └── kustomization.yaml
  │   │   │   ├── kafka.yaml
  │   │   │   ├── ksqldb
  │   │   │   │   ├── ksqldb.yaml
  │   │   │   │   └── kustomization.yaml
  │   │   │   ├── kustomization.yaml
  │   │   │   ├── schmea-registry
  │   │   │   │   ├── kustomization.yaml
  │   │   │   │   └── schema-registry.yaml
  │   │   │   ├── secrets
  │   │   │   │   ├── ca-pair-sslcerts.yaml
  │   │   │   │   ├── kustomization.yaml
  │   │   │   │   └── mds-public.yaml
  │   │   │   └── zookeeper.yaml
  │   │   └── kustomization.yaml
  │   ├── environments
  │   │   ├── kustomization.yaml
  │   │   ├── production
  │   │   │   ├── kustomization.yaml
  │   │   │   └── namespace.yaml
  │   │   └── sandbox
  │   │       ├── kafka.yaml
  │   │       ├── kustomization.yaml
  │   │       ├── namespace.yaml
  │   │       └── zookeeper.yaml
  │   ├── operator
  │   │   ├── confluent-operator-helm-release-confluent.yaml
  │   │   ├── kustomization.yaml
  │   │   └── namespace.yaml
  │   ├── terraform
  │   │   ├── confluent-cloud.yaml
  │   │   ├── kustomization.yaml
  │   │   └── namespace.yaml
  │   └── tf-controller
  │       ├── kustomization.yaml
  │       └── terraform-controller-helm-release.yaml
  ```
# Example usage
examples: |-
  ### Deployment Process
  #### 1. Create your Kubernetes cluster
  We will be using MiniKube, but any remote cluster will work. Create the cluster using: 
  * Run `minikube start --cpus=6 --memory=20019 --kubernetes-version=v1.21.0`
  
  #### 2. Deploy the GitOps toolkit
  Toolkit CRDs and components are deployed using: 
  * Navigate to `./flux-system`
  * Run `kubectl apply -f gotk-components.yaml`

  #### 3. Deploy Flux Sync
  * Navigate to `./flux-system`
  * run `kubectl apply -f gotk-sync.yaml`
  This next step will tell Flux what repository to monitor, and, within that repository, what kustomization files to start with. The first Kustomize resource that Flux will look for to is located at `./kustomize/operator`.  This will install the confluent-for-kubernetes Helm chart which will monitor all namespaces for Confluent CRDs.   
  After a successful health check of the operator (which will run as a pod), Flux will then proceed to deploy the following Kustomizations:
    * Production environment located at  `./kustomize/environments/production`
    * Sandbox environment located at  `./kustomize/environments/sandbox`
    * TF Controller for reconciling Terraform resources in the GitOps way located at `./kustomize/environments/tf-controller`
    * Auto Apply Terraform using the variables located at `./kustomize/environments/terraform`
    
  #### 4. Let Flux work its magic
  Now that we have flux monitoring the forked Git repository, let's demonstrate the GitOps behaviour!  If everything has deployed successfully, you should see a healthy confluent stack looking like this:
    ```console
    │ NAME                                          PF   READY      RESTARTS STATUS      IP              NODE         AGE        │
    │ confluent-operator-global-7ffc5b469d-knmfj    ●    1/1               0 Running     172.17.0.7      minikube     21m        │
    │ connect-0                                     ●    1/1               0 Running     172.17.0.17     minikube     9m31s      │
    │ controlcenter-0                               ●    1/1               1 Running     172.17.0.11     minikube     21m        │
    │ kafka-0                                       ●    1/1               3 Running     172.17.0.8      minikube     21m        │
    │ kafka-1                                       ●    1/1               3 Running     172.17.0.10     minikube     21m        │
    │ kafka-2                                       ●    1/1               3 Running     172.17.0.9      minikube     21m        │
    │ ksqldb-0                                      ●    1/1               1 Running     172.17.0.12     minikube     21m        │
    │ schemaregistry-0                              ●    1/1               1 Running     172.17.0.14     minikube     21m        │
    │ zookeeper-0                                   ●    1/1               0 Running     172.17.0.15     minikube     21m        │
    │ zookeeper-1                                   ●    1/1               0 Running     172.17.0.16     minikube     21m        │
    │ zookeeper-2                                   ●    1/1               0 Running     172.17.0.13     minikube     21m        │
    │
    ```

related:
  - name: "Terraform GitOps Example"
    description: "A Terraform GitOps workflow showcasing how to use the TF-Controller to run your Terraform via GitOps"
    url: "https://github.com/osodevops/terraform-gitops-example"
  - name: "Kafka GitOps Example"
    description: "A Kafka / Confluent GitOps workflow example for multi-env deployments with Flux, Kustomize, Helm and Confluent Operator"
    url: "https://github.com/osodevops/kafka-gitops-examples"
  - name: "Confluent Platform on Azure"
    description: "Terraform Module for deploying best practice HA Confluent Platform on Azure"
    url: "https://github.com/osodevops/terraform-azure-confluent-platform"
